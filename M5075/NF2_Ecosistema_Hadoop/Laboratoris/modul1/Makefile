.PHONY: help download-cache build up clean deep-clean shell-master shell-slave1 shell-slave2

help:
	@echo "InformaciÃ³ de totes les opcions"

# Descarregar Hadoop i Hive a la memÃ²ria cau local (accelera reconstruccions)
download-cache:
	@echo "ğŸ“¦ Descarregant fitxers a la memÃ²ria cau local..."
	@cd Base && ./download-cache.sh

# Variables
# AutodetecciÃ³ de Docker Compose (V2 "docker compose" o V1 "docker-compose")
DOCKER_COMPOSE := $(shell \
	if docker compose version >/dev/null 2>&1; then echo "docker compose"; \
	elif command -v docker-compose >/dev/null 2>&1; then echo "docker-compose"; \
	else echo "docker compose"; fi)

# Construir les imatges
build:
	@echo "ğŸ”¨ Construint imatges Docker..."
	$(DOCKER_COMPOSE) build

# Aixecar el clÃºster
up:
	@echo "ğŸš€ Aixecant clÃºster Hadoop (2 nodes)..."
	$(DOCKER_COMPOSE) up -d
	@echo "â³ Esperant 20 segons perquÃ¨ els serveis estiguin llestos..."
	@for i in $$(seq 1 20); do \
		printf "\r["; \
		for j in $$(seq 1 20); do \
			if [ $$j -le $$i ]; then printf "â–ˆ"; else printf "â–‘"; fi; \
		done; \
		printf "] $$i/20s"; \
		sleep 1; \
	done; \
	echo ""
	@echo "âœ… ClÃºster aixecat!"
	@echo "ğŸ“Š NameNode UI: http://localhost:9870"
	@echo "ğŸ“Š ResourceManager UI: http://localhost:8088"

clean:
	@echo "ğŸ§¹ Netejant contenidors, volums i xarxa del projecte..."
	$(DOCKER_COMPOSE) down -v
	@echo "âœ… Neteja completada!"
	@echo "ğŸ’¡ Per eliminar tambÃ© les imatges utilitza: make deep-clean"


# Neteja profunda: elimina ABSOLUTAMENT TOT (contenidors, volums, imatges, xarxa i memÃ²ria cau)
deep-clean:
	@echo "ğŸ”¥ NETEJA PROFUNDA - Eliminant recursos del projecte..."
	@echo "âš ï¸  AixÃ² eliminarÃ :"
	@echo "   - Contenidors del clÃºster Hadoop (master, slave1)"
	@echo "   - Volums de dades del projecte"
	@echo "   - Imatges Docker del projecte (modulo1-*)"
	@echo "   - Xarxa del clÃºster"
	@echo "   - MemÃ²ria cau de build del projecte"
	@echo ""
	@read -p "EstÃ s segur? (s/N): " confirm && [ "$$confirm" = "s" ] || [ "$$confirm" = "S" ] || (echo "OperaciÃ³ cancelÂ·lada" && exit 1)
	@echo ""
	@echo "ğŸ—‘ï¸  Aturant i eliminant contenidors i volums del projecte..."
	@$(DOCKER_COMPOSE) down -v 2>/dev/null || true
	@echo "ğŸ—‘ï¸  Eliminant imatges del projecte..."
	@docker rmi modulo1-master modulo1-slave1 2>/dev/null || true
	@echo "ğŸ—‘ï¸  Eliminant volums del projecte..."
	@docker volume rm modulo1_master-data modulo1_slave1-data 2>/dev/null || true
	@echo "ğŸ—‘ï¸  Eliminant xarxa del projecte..."
	@docker network rm modulo1_hadoop-net 2>/dev/null || true
	@echo "ğŸ—‘ï¸  Netejant memÃ²ria cau de build (nomÃ©s capes no utilitzades)..."
	@docker build

# Accedir a la shell del master
shell-master:
	docker exec -it -u hadoop hadoop-master bash

# Accedir a la shell de slave1
shell-slave1:
	docker exec -it -u hadoop hadoop-slave1 bash

# Accedir a la shell de slave2
shell-slave2:
	docker exec -it -u hadoop hadoop-slave2 bash
